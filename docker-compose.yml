services:
  # PostgreSQL database
  postgres:
    image: postgres:16-alpine
    container_name: uptime-kabomba-postgres
    environment:
      - POSTGRES_DB=uptime
      - POSTGRES_USER=uptime
      - POSTGRES_PASSWORD=secret
    volumes:
      - postgres-data:/var/lib/postgresql/data
    restart: unless-stopped

  # Backend API
  backend:
    build: .
    image: ghcr.io/fuomag9/uptime-kabomba-backend:latest
    container_name: uptime-kabomba-backend
    # No ports exposed - only accessible via Docker internal network
    environment:
      - DATABASE_TYPE=postgres
      - POSTGRES_HOST=${POSTGRES_HOST:-postgres}
      - POSTGRES_PORT=${POSTGRES_PORT:-5432}
      - POSTGRES_DB=${POSTGRES_DB:-uptime}
      - POSTGRES_USER=${POSTGRES_USER:-uptime}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-secret}
      - POSTGRES_SSLMODE=${POSTGRES_SSLMODE:-disable}
      - PORT=8080
      - METRICS_TOKEN=${METRICS_TOKEN:-change-me}
      - HEALTH_TOKEN=${HEALTH_TOKEN:-change-me}
      - ENVIRONMENT=${ENVIRONMENT:-production}
      - JWT_SECRET=${JWT_SECRET}
      - APP_URL=${APP_URL:-http://localhost:3000}
      - OAUTH_ISSUER=${OAUTH_ISSUER}
      - OAUTH_CLIENT_ID=${OAUTH_CLIENT_ID}
      - OAUTH_CLIENT_SECRET=${OAUTH_CLIENT_SECRET}
      - OAUTH_SCOPES=${OAUTH_SCOPES:-openid,profile,email}
      # Set to true to allow monitoring private IP addresses (192.168.x.x, 10.x.x.x, etc.)
      # WARNING: Only enable this if you trust all users, as it bypasses SSRF protection
      - ALLOW_PRIVATE_IPS=${ALLOW_PRIVATE_IPS:-false}
      # Set to true to allow monitoring cloud metadata endpoints (169.254.169.254, etc.)
      # WARNING: This is dangerous in cloud environments. Only enable if absolutely necessary.
      - ALLOW_METADATA_ENDPOINTS=${ALLOW_METADATA_ENDPOINTS:-false}
    # Grant CAP_NET_RAW capability for ICMP ping (raw sockets)
    # This allows ping to work without running as root
    cap_add:
      - NET_RAW
    restart: unless-stopped
    depends_on:
      - postgres
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "--header", "X-Health-Token: ${HEALTH_TOKEN:-change-me}", "http://localhost:8080/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

  # Frontend Web UI
  frontend:
    build:
      context: ./web
      dockerfile: Dockerfile
    image: ghcr.io/fuomag9/uptime-kabomba-frontend:latest
    container_name: uptime-kabomba-frontend
    ports:
      - "3000:3000"
    environment:
      # Empty string means API calls use relative URLs (proxied through Next.js)
      - NEXT_PUBLIC_API_URL=
      - INTERNAL_API_URL=http://backend:8080
    restart: unless-stopped
    depends_on:
      - backend

volumes:
  postgres-data:
    driver: local
